<!-- fundi-dash.component.html -->

<!-- Hidden menu trigger for AppBar action button -->
<button 
  #accountMenuTrigger="matMenuTrigger"
  [matMenuTriggerFor]="accountMenu"
  style="display: none;">
</button>

<!-- Account Menu -->
<mat-menu #accountMenu="matMenu">
  <button mat-menu-item (click)="goToProfile()">
    <mat-icon>person</mat-icon>
    <span>Profile</span>
  </button>
  <button mat-menu-item (click)="goToSettings()">
    <mat-icon>settings</mat-icon>
    <span>Settings</span>
  </button>
  <mat-divider></mat-divider>
  <button mat-menu-item (click)="logout()">
    <mat-icon>logout</mat-icon>
    <span>Logout</span>
  </button>
</mat-menu>

<div class="page">
  
  @if (isMobile()) { 
    <br><br>
    
    <!-- Welcome Card -->
    <section class="card welcome-card">
      <div class="welcome-content">
        <img 
          [src]="imgFile ? imgUrl + imgFile : 'assets/user.png'" 
          alt="Profile" 
          class="profile-avatar"
        />
        <div class="welcome-text">
          <h2>Welcome, {{ username }}!</h2>
          <p>Keep logging work to build your credibility.</p>
        </div>
      </div>
    </section>

    <!-- Work History Status Card (REPLACES Credit Score) -->
    <section class="card trust-status-card">
      <h3>üõ°Ô∏è Work History Status</h3>
      <div class="trust-metrics">
        <div class="metric-row">
          <span class="label">Verified Days (30d)</span>
          <span class="value">{{ verifiedDays }}</span>
        </div>
        <div class="metric-row">
          <span class="label">Verification Rate</span>
          <span class="value">{{ verificationRate }}%</span>
        </div>
        <div class="metric-row">
          <span class="label">Sites Worked</span>
          <span class="value">{{ sitesWorked }}</span>
        </div>
        <div class="metric-row">
          <span class="label">Disputes</span>
          <span class="value">{{ disputes }}</span>
        </div>
      </div>
    </section>

    <!-- Work Activity Timeline -->
    <section class="card timeline-card">
      <h3>üìÜ Work Activity (Last 30 Days)</h3>
      <div class="activity-calendar">
        @for (day of last30Days; track day.date) {
          <div class="day-cell" 
               [class.verified]="day.status === 'verified'"
               [class.pending]="day.status === 'pending'"
               [class.empty]="day.status === 'empty'"
               [title]="day.tooltip">
            {{ day.dayNum }}
          </div>
        }
      </div>
      <div class="legend">
        <span><span class="dot verified"></span> Verified</span>
        <span><span class="dot pending"></span> Pending</span>
        <span><span class="dot empty"></span> No work</span>
      </div>
    </section>

    <!-- Quick Actions Grid (UPDATED LABELS) -->
    <section class="mobile-nav">
      <!-- Log Work -->
      <div class="nav-card" routerLink="/main-menu/gig">
        <i class="material-icons">add</i>
        <span>Log Work</span>
      </div>

      <!-- Payment Proof -->
      <div class="nav-card" routerLink="/main-menu/proof-of-payments">
        <i class="material-icons">upload_file</i>
        <span>Payment Proof</span>
      </div>

      <!-- M-Pesa -->
      <div class="nav-card" routerLink="/main-menu/mpesa">
        <i class="material-icons">payment</i>
        <span>M-PESA</span>
      </div>

      <!-- Verification Status -->
      <div class="nav-card" routerLink="/main-menu/verification-status">
        <i class="material-icons">verified_user</i>
        <span>Verification</span>
      </div>

      <!-- Work History -->
      <div class="nav-card" routerLink="/main-menu/work-history">
        <i class="material-icons">history</i>
        <span>Work History</span>
      </div>

      <!-- Profile -->
      <div class="nav-card" routerLink="/main-menu/profile">
        <i class="material-icons">person</i>
        <span>Profile</span>
      </div>
    </section>

    <!-- Work History Summary (RENAMED) -->
    <section class="card list-card" routerLink="/main-menu/gig-list">
      <div class="list-item">
        <i class="material-icons green">work_outline</i>
        <div>
          <h4>Work History Summary</h4>
          <p>{{ verifiedGigs }} Verified / {{ totalGigs }} Total Days</p>
        </div>
        <i class="material-icons">chevron_right</i>
      </div>
    </section>

    <!-- Profile Summary Card -->
    <section class="card profile-card">
      <h3>Profile Information</h3>
      <div class="profile-info">
        <div class="info-row">
          <i class="material-icons">person</i>
          <span>{{ fullname }}</span>
        </div>
        <div class="info-row">
          <i class="material-icons">email</i>
          <span>{{ email }}</span>
        </div>
        <div class="info-row">
          <i class="material-icons">location_on</i>
          <span>{{ location }}</span>
        </div>
      </div>
    </section>

    <!-- Credit Readiness Preview (MOVED TO BOTTOM, LOCKED) -->
    <section class="card credit-preview-card">
      <div class="locked-header">
        <i class="material-icons">lock</i>
        <h3>Credit Readiness (Preview)</h3>
      </div>
      <div class="preview-content">
        <div class="preview-row">
          <span>History length:</span>
          <strong>{{ historyMonths }} months</strong>
        </div>
        <div class="preview-row">
          <span>Minimum required:</span>
          <strong>3 months</strong>
        </div>
        <div class="status-row" [class.ready]="historyMonths >= 3">
          <span>Status:</span>
          <strong>{{ historyMonths >= 3 ? '‚úì Ready' : '‚è≥ Building history' }}</strong>
        </div>
      </div>
    </section>
  }

  <!-- üî• DESKTOP DASHBOARD (UPDATED FOR TRUST) -->
  @if (!isMobile()) {
    <!-- Desktop Header -->
    <div class="desktop-header">
      <h1>Work History Dashboard</h1>
      <p>Track your verified work to build credibility</p>
    </div>

    <!-- Stats Grid (UPDATED LABELS) -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon bg-blue">
            <i class="material-icons">verified</i>
          </div>
        </div>
        <h3>Verified Days</h3>
        <p class="stat-value">{{ verifiedDays }}</p>
        <p class="stat-subtitle">Last 30 days</p>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon bg-green">
            <i class="material-icons">location_city</i>
          </div>
        </div>
        <h3>Sites Worked</h3>
        <p class="stat-value">{{ sitesWorked }}</p>
        <p class="stat-subtitle">Active locations</p>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon bg-purple">
            <i class="material-icons">trending_up</i>
          </div>
        </div>
        <h3>Verification Rate</h3>
        <p class="stat-value">{{ verificationRate }}%</p>
        <p class="stat-subtitle">Trust score</p>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon bg-orange">
            <i class="material-icons">calendar_month</i>
          </div>
        </div>
        <h3>This Month</h3>
        <p class="stat-value">{{ verifiedGigs }}</p>
        <p class="stat-subtitle">Verified days</p>
      </div>
    </div>

    <!-- Desktop Content Grid -->
    <div class="desktop-grid">
      <!-- Recent Work Logs (RENAMED & UPDATED) -->
      <div class="desktop-card recent-jobs">
        <div class="card-header">
          <h2>Recent Work Logs</h2>
        </div>
        <div class="jobs-list">
          @for (log of recentWorkLogs; track log.id) {
            <div class="job-item">
              <div class="job-main">
                <div class="job-info">
                  <h3>{{ log.siteName }}</h3>
                  <p>{{ log.jobType }}</p>
                </div>
                <span class="job-status">{{ log.date }}</span>
              </div>
              <div class="job-footer">
                <span class="status-badge" [class.completed]="log.verified" [class.pending]="!log.verified">
                  <i class="material-icons">{{ log.verified ? 'verified' : 'schedule' }}</i>
                  {{ log.verified ? 'Verified' : 'Pending' }}
                </span>
                <span class="verified-by" *ngIf="log.verified">by {{ log.foremanName }}</span>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Work Activity Timeline (RIGHT COLUMN) -->
      <div class="desktop-card">
        <div class="card-header">
          <h2>Work Activity</h2>
        </div>
        <div class="timeline-desktop">
          <div class="activity-calendar-desktop">
            @for (day of last30Days; track day.date) {
              <div class="day-cell-desktop" 
                   [class.verified]="day.status === 'verified'"
                   [class.pending]="day.status === 'pending'"
                   [class.empty]="day.status === 'empty'"
                   [title]="day.tooltip">
                {{ day.dayNum }}
              </div>
            }
          </div>
          <div class="legend">
            <span><span class="dot verified"></span> Verified</span>
            <span><span class="dot pending"></span> Pending</span>
            <span><span class="dot empty"></span> No work</span>
          </div>
        </div>

        <!-- Trust Metrics -->
        <div class="trust-metrics-desktop">
          <h3>Trust Metrics</h3>
          <div class="metric-item">
            <span class="label">Verified Days (30d)</span>
            <span class="value">{{ verifiedDays }}</span>
          </div>
          <div class="metric-item">
            <span class="label">Verification Rate</span>
            <span class="value">{{ verificationRate }}%</span>
          </div>
          <div class="metric-item">
            <span class="label">Disputes</span>
            <span class="value">{{ disputes }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Credit Readiness (DESKTOP BOTTOM) -->
    <section class="card credit-preview-card-desktop">
      <div class="locked-header">
        <i class="material-icons">lock</i>
        <h3>Credit Readiness (Preview)</h3>
      </div>
      <div class="preview-content-desktop">
        <div class="preview-metric">
          <span class="label">History length</span>
          <span class="value">{{ historyMonths }} months</span>
        </div>
        <div class="preview-metric">
          <span class="label">Minimum required</span>
          <span class="value">3 months</span>
        </div>
        <div class="preview-metric status" [class.ready]="historyMonths >= 3">
          <span class="label">Status</span>
          <span class="value">{{ historyMonths >= 3 ? '‚úì Ready' : '‚è≥ Building' }}</span>
        </div>
      </div>
    </section>
  }
</div>